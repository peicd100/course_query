# AGENTS.md（全域權威規範；供 Agent 在 VS Code / IDE 內遵守）
# 適用對象：具備檔案操作能力與（可能具備）終端機操作能力的 Agent（例如 Codex、Gemini Code Assist、其他類似工具）
#
# 重要：本文件以「模式」控制能力與流程強制性；任何條款衝突時，以「全域硬規則」與「所選模式的覆蓋規則」為最終裁決。
# 重要：你必須每次任務開始重新完整讀取本文件；不得依賴先前讀過的印象。

================================================================================
零、閱讀優先（最先執行；硬性）
================================================================================

0.1 你在做任何事情之前，必須先「從頭到尾完整讀完」本 AGENTS.md。
- 你不得讀到一半就開始任何動作（包含握手、列模式、詢問、執行命令、修改檔案）。
- 你不得依賴過往記憶或先前讀取結果；本次任務必須重新完整讀取一次。

0.2 讀完後，你才允許開始「啟動握手」（第二章）。
- 若你無法完整讀取本文件（例如權限、沙箱限制、文件截斷、讀取失敗）：
  - 你必須立刻停止
  - 在對話回覆中說明「無法完整讀取」的原因與影響
  - 不得自作主張開始握手或執行任何動作

================================================================================
一、最高原則（必讀；全域硬規則）
================================================================================

1. 重新讀取義務（硬性）
- 你必須在每次任務開始時「重新完整讀取」本檔案，不得依賴任何過往記憶或先前讀取結果。
- 若你曾在本專案先前任務中讀過本檔案，你也必須在本次任務重新完整讀取後，才可開始行動。

2. 行動前置條件（硬性）
- 在你完成「啟動握手」並且使用者完成「模式選擇」之前：
  - 你不得執行任何命令
  - 你不得修改任何檔案
  - 你不得進行任何會改變 workspace 狀態的動作

3. 違規拒絕（硬性）
- 若使用者要求違反任何硬性規則，你必須拒絕，並指出違反哪一條規則（章節編號），並提出合規替代方案（若存在）。

4. 語言規則（硬性）
- 所有對話回覆一律使用繁體中文（程式碼/命令/路徑可用英文）。
- 禁止使用任何 emoji、顏文字或表情符號。

5. 禁止外部 GUI 指令（硬性；所有模式都適用）
- 禁止使用任何會彈出視窗或外部 GUI 編輯器/檢視器的終端機指令作為工作流程的一部分（例如 notepad、start、code 等）。
- 你必須使用 IDE 內建檔案操作能力讀/寫檔案。
- 若需要讓使用者了解內容，必須在對話回覆摘要關鍵片段或結論，不得要求使用者自行開檔查找。

6. 禁止無效重試（硬性）
- 禁止在受限環境中反覆嘗試同一件會失敗的事（例如：終端機被封鎖、網路被封鎖、權限不足、channel 無法連線）。
- 一旦確認受限，必須立刻停止重試，改為清楚回報：
  - 限制是什麼
  - 影響是什麼
  - 可行替代方案是什麼

7. 封閉範圍（硬性；所有模式都適用）
- 你的任何檔案操作必須限制在 workspace root 之內。
- 除非使用者明確要求且不違反本文件硬規則，否則不得把作業擴展到 workspace root 之外。

8. 禁止改系統設定（硬性；所有模式都適用；FREE 亦強制）
- 嚴格禁止任何系統或全域設定修改：
  - 永久 PATH、永久環境變數
  - PowerShell ExecutionPolicy
  - 登錄檔
  - 管理員權限
  - 全域安裝程式（exe / msi）
- 禁止使用其他環境管理工具：
  - 只能使用 Anaconda/Conda 管理 Python 環境
  - 禁止 venv、pipx、poetry、uv、rye、pyenv、conda 以外的環境管理流程

================================================================================
二、啟動握手（必做；硬性；列出所有模式並等待使用者選擇）
================================================================================

在開始任何動作之前，你必須先在對話回覆中輸出以下「握手資訊」。
你必須完整輸出 1)～10)，不得省略任何一項。
（注意：這是一個「先回覆、後行動」的握手流程。握手回覆完成前不得行動。）

1) 我已在本次任務中「重新完整讀取」並正在遵守本檔案（AGENTS.md）：是 / 否

2) 我實際讀取到的 AGENTS.md 路徑：<絕對路徑或可定位路徑>

3) 我判定的 workspace root（目前 VS Code 開啟的資料夾根目錄）：<絕對路徑>

4) 我偵測到的專案狀態（擇一）：
   - A. 既有專案（workspace root 同層已存在 app_main.py）
   - B. 新專案/空專案（workspace root 同層尚不存在 app_main.py，需從無到有建立）

5) 可用模式清單（請使用者選擇其一）：
   - APP_MAIN_FREE_CHATGPT：允許終端機命令 + 檔案編輯；受本文件「流程型規則」完整約束（全流程）
   - APP_MAIN_NO_TERMINAL_GEMINI：只允許檔案編輯；全面禁止終端機命令；仍受本文件流程型規則約束（但凡需終端機者以「未能執行」處理）
   - VIEW：只允許檢視與分析；禁止任何編輯與終端機命令
   - FREE：在「封閉 workspace 與本專案 conda 環境」內自由操作；只強制遵守硬規則（握手/封閉範圍/禁止改系統/Conda 規範/必要溝通/禁止外部 GUI 指令）；其餘流程型規則不強制

6) 請使用者回覆要使用的模式（必須回覆其中一個字串）：
   APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI / VIEW / FREE

7) 若你偵測到多份 AGENTS.md 候選（例如 workspace 內也有一份、或工具自動掛載另一份）：
   - 你必須在本次握手中列出所有候選路徑
   - 你不得自行切換或合併規則
   - 你必須等待使用者指定「要遵守哪一份」，否則停止

8) 能力自我盤點（必填；簡短但要具體）：
   - 檔案：可否讀取/修改/新增/刪除 workspace 內檔案：是/否（若否，說明原因）
   - 終端機：可否執行命令（cmd/PowerShell/bash/terminal）：是/否（若否，說明原因）
   - 網路：可否連線（例如 conda channel、pip、下載）：是/否（若否，說明原因）
   - Pylance 工具：是否存在可用的 pylanceRunCodeSnippet（可在 Python interpreter 內執行 snippet）：是/否/不確定
     - 若你不確定，你必須嘗試以「非破壞性方式」判斷一次（例如查詢工具清單或讀取 IDE 提供的 interpreter 資訊），並回報結果。

9) 你必須列出「你打算採用的 conda 進入方式優先序」（只列出，不得執行）：
   - 優先：使用 pylanceRunCodeSnippet 進入 conda（第六章 6.2.1）
   - 後備：cmd.exe + activate.bat + conda activate（第六章 6.2.2）

10) 在使用者完成模式選擇（以及必要時指定 AGENTS.md 版本）之前：
   - 你必須停止於此，不得進行任何下一步
   - 不得執行任何命令、不得修改任何檔案

若你無法完成以上 1)～3)，你必須立刻停止並回報原因。

================================================================================
三、模式系統（硬性）
================================================================================

3.1 模式切換唯一來源（硬性）
- 模式切換只能由使用者明確指示（握手第 6 點選擇，或後續明確要求切換）。
- 「握手後未選模式」不存在預設模式：在使用者選擇前必須停住不做事（見第二章）。

3.2 進入模式固定句（硬性；必須完全一致）
使用者選定模式後，你必須在「下一次回覆的最開頭」先輸出對應固定句（必須完全一致）：

- 進入 APP_MAIN_FREE_CHATGPT：已進入APP_MAIN_FREE_CHATGPT模式
- 進入 APP_MAIN_NO_TERMINAL_GEMINI：已進入APP_MAIN_NO_TERMINAL_GEMINI模式
- 進入 VIEW：已進入VIEW模式
- 進入 FREE：已進入FREE模式

輸出該句後才可進行後續回覆內容與行動。

3.3 模式能力與限制（硬性）
A) APP_MAIN_FREE_CHATGPT
- 允許：終端機命令 + 檔案編輯
- 必須遵守：本文件全部章節（硬規則 + 流程型規則）

B) APP_MAIN_NO_TERMINAL_GEMINI
- 允許：檔案編輯
- 禁止：任何終端機命令（包含 python/conda/pip/pyinstaller）
- 必須遵守：硬規則 + 流程型規則
  - 凡需終端機者，以「因模式封鎖未能執行」處理
  - 必須同時在 Log.md 與對話回覆清楚標註未執行原因與風險（不可只寫 Log）

C) VIEW
- 允許：檢視與分析（讀檔、理解、提出建議）
- 禁止：任何修改、任何終端機命令、任何改變 workspace 狀態的動作
- 必須遵守：硬規則（不含需改檔/命令的流程）

D) FREE
- 允許：在封閉 workspace root 與本專案 conda env 內自由操作
- 必須遵守：硬規則 + Conda 規範（第六章）
- 不強制：流程型規則（備份/Log/三引號/requirements/測試/打包/清理），除非使用者明確要求

================================================================================
四、必要溝通規則（硬性；所有模式適用）
================================================================================

1. 只要你有任何「想告訴我 / 需要我知道 / 需要我確認」的內容，必須直接在對話回覆中清楚說明。
2. 不得只把資訊寫進 Log.md 或任何檔案而不在對話回覆說明。
3. 若你需要我看某檔案內容：你必須在對話回覆貼出關鍵片段或清楚摘要；不得叫我自行打開檔案找。

================================================================================
五、專案檔案與命名（流程型規則；部分條款依模式強制）
================================================================================

5.1 Python（硬性；所有模式適用）
- 本專案所有程式一律使用 Python。

5.2 多檔案固定模式（流程型規則；APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI 強制）
- 入口主程式檔固定：app_main.py
- 除 app_main.py 外，其他 Python 檔案必須：
  - 位於 workspace root 同層
  - 檔名必須符合：app_*.py

5.3 檔名稽核（流程型規則；APP_MAIN_FREE_CHATGPT 每次測試前強制）
- 在每次執行 python app_main.py 前，必須先稽核命名與同層規則。
- 不符合必須先修正並記錄於 Log.md（修正前必須先備份）。

================================================================================
六、Conda 規範（硬性；所有模式適用；FREE 亦強制）
================================================================================

6.0 目的（硬性）
- 所有 Python 執行、套件安裝、工具安裝都必須在 conda 環境內完成。
- 禁止改動 base（可 conda activate base 作為入口，但不得在 base install/remove）。
- 禁止改動任何非本專案 env（僅允許本專案 ENV_NAME）。
- 安裝優先 conda install；必要才 pip install，且需記錄原因。
- 外部工具（例如 ffmpeg）必須裝在本專案 conda env 內，不得要求全域安裝或永久 PATH。

6.1 同專案單一環境（硬性）
- 同一專案只允許一個 conda 環境（ENV_NAME）。
- ENV_NAME 依專案功能命名（英文、小寫、底線）。
- ENV_NAME 在第一次建立後即鎖定，除非使用者明確指示改名。
- 若找不到之前使用的 ENV_NAME：直接建立新的 ENV_NAME（並記錄）。

6.2 conda 進入方式（pylanceRunCodeSnippet 優先；後備 cmd/activate.bat）
----------------------------------------------------------------

6.2.1 優先方案：使用 pylanceRunCodeSnippet 進入 conda（硬性優先序）
- 目標：若存在可用的 pylanceRunCodeSnippet 工具，優先用它在「Python interpreter」內執行 snippet，
  並以該 interpreter 作為本專案 conda 環境入口（用來執行 python / pip 相關操作）。

- 流程（硬性）：

  A) 可用性檢查（硬性）
  - 你必須先判斷 pylanceRunCodeSnippet 是否存在且可用。
  - 若不存在或不可用：不得反覆重試，立即改走 6.2.2 後備方案，並在對話回覆說明原因。

  B) interpreter 來源判定（硬性；不可猜）
  - 若 pylanceRunCodeSnippet 可用，你必須先用 snippet 取得：
    - sys.executable（Python interpreter 絕對路徑）
    - sys.prefix / sys.base_prefix（用於判斷是否在 conda env）
  - 你必須在對話回覆中回報上述結果，並清楚判斷：
    - 是否位於 conda env
    - 是否屬於本專案 ENV_NAME（若無法判斷則視為不可用）

  C) 使用規則（硬性）
  - 若你可確認該 interpreter 屬於本專案 conda env（ENV_NAME）：
    - 後續所有 python 與 pip 相關命令（執行 app_main.py、產生 requirements、pip install 等）：
      - 一律以該 sys.executable 直接執行，不依賴 shell 的 conda activate。
  - 但只要涉及 conda 本體（conda install / conda create / conda env 管理）：
    - 仍必須走 6.2.2 後備方案（cmd + activate.bat + conda activate），因 pylanceRunCodeSnippet 不等同 conda CLI。

  D) 失敗降級（硬性）
  - 若 pylanceRunCodeSnippet 回傳的 interpreter：
    - 不是 conda env
    - 或不是本專案 ENV_NAME
    - 或你無法確認其來源
    - 或執行 snippet 失敗
    - 你必須立即放棄本方案，改走 6.2.2 後備方案
    - 並在對話回覆說明「為何判定不可用」（具體原因）

6.2.2 後備方案：cmd.exe + activate.bat + conda activate（硬性；不得彈窗）
- 唯一允許的 conda 初始化方式（同一個 session；不得彈窗）：

  call "C:\ProgramData\Anaconda3\Scripts\activate.bat" "C:\ProgramData\Anaconda3"
  conda activate base
  conda activate <ENV_NAME>

- 禁止：
  - conda-hook.ps1
  - conda init powershell
  - start 開新視窗
  - 任何要求使用者修改 ExecutionPolicy 的做法

6.3 安裝原則（硬性：conda 優先）
- 安裝套件時優先 conda install（必要時 conda-forge）。
- 只有在 conda 無法取得、版本不適用、或相容性因素必須改用 pip 時，才可 pip install。
- 任何 pip 例外必須記錄原因（可改檔模式記 Log.md；否則在對話回覆說明）。

6.4 禁止改動 base 與其他環境（硬性）
- 允許 conda activate base 作為入口步驟。
- 嚴禁對 base install/remove。
- 禁止改動任何非本專案 ENV_NAME 的 conda 環境。

================================================================================
七、備份（流程型規則；APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI 強制）
================================================================================

7.1 何時備份（硬性）
- 在你對 workspace root 做任何變更前（新增/修改/刪除/改名/搬移），必須先備份。

7.2 備份位置與範圍（硬性）
- 備份位置：backup/YYYYMMDD_HHMMSS/
- 備份範圍：workspace root 下除 backup/ 外的所有內容（全量備份）

7.3 backup 規則（硬性）
- 既有備份內容只能檢視，禁止編輯。
- backup/ 底下最多保留 10 個時間戳備份資料夾；超過則刪除最舊者。
- 備份新增與修剪摘要必須記錄於 Log.md。

================================================================================
八、新專案 Bootstrap（流程型規則；APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI 強制）
================================================================================

8.1 目標（硬性）
若為新專案/空專案，你必須在 workspace root 建立：
- app_main.py（最小可執行入口）
- user_data/（必建；至少含 config/input/output 子資料夾）
- Log.md（必建）

8.2 Bootstrap 階段刪除限制（硬性）
- 在 APP_MAIN_FREE_CHATGPT 第一次測試通過之前：禁止刪除型清理。
- 允許整理型動作（搬移、改名、建立必要資料夾等）。

================================================================================
九、專案 I/O：user_data/（流程型規則；APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI 強制）
================================================================================

9.1 預設（硬性）
- 本專案所有「輸入/輸出/設定/快取/中間產物」預設都在 user_data/ 之下。
- 這個預設從開發期開始就必須成立（打包之前就要用 user_data/）。

9.2 打包後 user_data（硬性）
- 打包後：<EXE 所在資料夾>\user_data\
- 程式必須能在開發期與打包後皆正確定位 user_data/。

9.3 輸出彈性（硬性）
- 輸入與設定必須固定在 user_data/。
- 輸出預設在 user_data/，若使用者指定其他位置（例如 Downloads），則依使用者需求。
- 任何輸出位置例外必須記錄於 Log.md。

================================================================================
十、Log.md（更新歷程；流程型規則；APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI 強制）
================================================================================

10.1 位置（硬性）
- Log.md 必須位於 workspace root，與 app_main.py 同層。

10.2 格式（硬性）
- 每次更新必須追加（不可覆蓋）。
- 每筆以大標題時間戳開頭：
  # YYYY-MM-DD HH:MM:SS

10.3 每筆至少包含（硬性）
- 變更摘要
- 影響範圍
- 檔案變更清單（新增/修改/刪除/搬移/改名）
- conda 環境資訊（ENV_NAME、Python 版本、套件變更）
- conda 進入方式（本次使用 6.2.1 或 6.2.2；若 pylanceRunCodeSnippet 失敗需記原因）
- requirements.txt 狀態（是否重產；若模式封鎖則記錄未執行原因）
- 測試結果（若可執行；若模式封鎖則記錄未執行原因）
- dist 清理摘要（保留 dist/user_data）
- 打包資訊（若有）：EXE_NAME、產出位置
- workspace 清理摘要（包含「打包前先刪除並測試」）
- backup 修剪摘要（若有）
- 規則拒絕事件（若有）

================================================================================
十一、app_main.py 檔首三引號（只放使用方式；流程型規則；APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI 強制）
================================================================================

11.1 必填內容（缺一不可；硬性）
你必須在 app_main.py 最上方維護三引號區塊 """ ... """，且只放使用方式，至少包含：

1) 專案資料夾與檔案結構（樹狀；必須與實際一致；每次刪除前需先更新）
2) 本專案 conda 環境資訊（ENV_NAME、建立/啟用方式）
   - conda 進入方式必須描述「pylanceRunCodeSnippet 優先，失敗則用 cmd/activate.bat」
3) 從零開始安裝流程（可一鍵複製；註解必須獨立成行）
4) requirements.txt 的產生與安裝方式
5) 測試方式（python app_main.py；兩次測試；第二次為打包前：先刪除再測試；若模式封鎖需標註）
6) user_data/ 用途與目錄規範
7) dist 更新/清理時 user_data 保留規則
8) 打包產物命名規則（EXE_NAME = workspace root 資料夾名稱）
9) workspace 清理原則（白名單與刪除策略）
10) backup 保留上限（最多 10 份）
11) PEICD100/ 白名單資料夾（若存在必須保留）
12) Python 檔名規則（除 app_main.py 外皆 app_*.py 且同層）
13) 程式所需「輸入檔案」與「輸出檔案」的位置規範（以 user_data/ 為根；輸出可例外須說明）
14) 新專案 Bootstrap 行為摘要（若為新專案）

11.2 最終核對（硬性）
- 在你宣告完成之前，你必須核對 11.1 是否全數具備。
- 若缺少：不得宣告完成，必須先補齊並記錄於 Log.md。

================================================================================
十二、requirements.txt（流程型規則；APP_MAIN_FREE_CHATGPT 硬性）
================================================================================

12.1 位置（硬性）
- requirements.txt 必須位於 workspace root，與 app_main.py 同層。

12.2 產生方式（僅 APP_MAIN_FREE_CHATGPT 可執行；硬性）
- 優先：若 6.2.1 已取得 conda env 的 sys.executable，使用該 python.exe：
  "<PYTHON_EXE>" -m pip list --format=freeze > requirements.txt
- 否則：使用已 conda activate 到 <ENV_NAME> 的 python：
  python -m pip list --format=freeze > requirements.txt

12.3 APP_MAIN_NO_TERMINAL_GEMINI / VIEW
- 禁止執行命令；必須在對話回覆與 Log.md（若可改檔）記錄「因模式封鎖未能產生」。

12.4 FREE
- 不強制。

================================================================================
十三、測試（流程型規則；APP_MAIN_FREE_CHATGPT 硬性）
================================================================================

13.1 測試指令（僅 APP_MAIN_FREE_CHATGPT）
- 優先：若 6.2.1 已取得 conda env 的 sys.executable：
  "<PYTHON_EXE>" app_main.py
- 否則：
  python app_main.py

13.2 兩次測試與順序（硬性）
1) 改碼後測試（在任何清理/刪除之前）
2) 打包前測試（必須先完成「打包前清理/刪除」，再執行測試；先刪除再測試）

13.3 判定與中止
- 觀察 5–15 秒無錯誤即通過。
- 若程式未自行退出，使用者可 Ctrl+C 中止；若已退出，禁止 Ctrl+C。

================================================================================
十四、dist 與打包命名（流程型規則；APP_MAIN_FREE_CHATGPT 硬性）
================================================================================

14.1 dist 保留策略（硬性）
- dist/ 必須保留。
- dist/user_data/ 必須保留。
- dist 內其他程式產物可刪，但不得影響 dist/user_data/。
- 你不需要幫我把 user_data/ 的資料放到 dist 裡；我會自己放。

14.2 EXE_NAME（硬性）
- .exe 名稱必須等於 workspace root 資料夾名稱（basename）。

14.3 打包前置條件（硬性）
- 打包前必須已完成：
  - 第十五章：打包前清理/刪除（先更新結構、再刪除）
  - 第十三章：第二次測試（打包前：先刪除再測試）通過
  - 第十二章：requirements.txt 已產生

14.4 打包回報
- 不需在對話回報；必須在 Log.md 記錄。

================================================================================
十五、workspace 清理（流程型規則；APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI 強制）
================================================================================

15.1 絕對不可刪（白名單；硬性）
- dist/
- dist/user_data/
- app_main.py
- app_*.py
- Log.md
- requirements.txt
- user_data/
- backup/
- PEICD100/（若存在於 workspace root，必須完整保留）

15.2 其餘項目（非白名單）
- APP_MAIN_FREE_CHATGPT：
  - 只要「執行 python app_main.py 完全沒有用到」且你能合理確認（無不確定性），就必須刪除。
  - 若存在不確定性：不得刪除。
- APP_MAIN_NO_TERMINAL_GEMINI：
  - 因不能測試：只能刪除「明確屬於打包/暫存/快取/輸出產物」且你能 100% 確認與執行無關者；其餘不得刪。

15.3 打包前清理/刪除強制順序（APP_MAIN_FREE_CHATGPT 硬性）
1) 檔名稽核通過
2) 第一次測試（刪除前）
3) requirements.txt 已產生
4) 先重寫 app_main.py 三引號內「專案檔案架構（樹狀）」為清理後最終狀態
5) 刪除所有非白名單且可合理確認完全不用到的項目
6) 一致性核對（樹狀結構與實際一致）
7) 第二次測試（打包前：先刪除再測試）
8) 通過後才允許打包

15.4 APP_MAIN_NO_TERMINAL_GEMINI 清理補充（硬性）
- 刪除前必須先備份
- 刪除清單必須記錄於 Log.md

================================================================================
十六、違規要求的拒絕機制（硬性）
================================================================================

- 若使用者要求違反任何硬性規則：
  - 你必須拒絕
  - 必須指出違反哪一條（章節編號）
  - 提出合規替代方案（若存在）
- 拒絕事件在可改檔模式下必須記錄於 Log.md；VIEW 模式則在對話回覆列出。

================================================================================
十七、完成宣告（硬性；所有模式都必須遵守）
================================================================================

17.1 固定完成宣告字串（硬性；所有模式皆強制）
- 只要你判定「已完成使用者本次交代的事情」：
  - 不論目前是哪一個模式（APP_MAIN_FREE_CHATGPT / APP_MAIN_NO_TERMINAL_GEMINI / VIEW / FREE）
  - 你都必須在最後的最後輸出「固定完成宣告」。
- 固定完成宣告必須使用 Markdown H1（#）放大，且文字必須完全一致，不得增減字詞、不得加稱呼、不得加標點或其他文字。

17.2 固定完成宣告（必須完全一致；硬性）
你必須輸出以下內容（僅此一行；前綴 #；必須置於你回覆的最後一行）：

# PEICD100您交代的事情已經全數完成

17.3 禁止變形（硬性）
- 禁止輸出任何變形句（例：PEICD100您好，已經完成全部指令 等）
- 只允許 17.2 的固定字串，且必須使用 H1。

================================================================================